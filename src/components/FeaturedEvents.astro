---
import { Card, Heading, Link } from 'accessible-astro-components'
import { Icon } from 'astro-icon/components'
import { getCollection } from 'astro:content'

// Import default event images for optimization
import eventImage1 from '@assets/images/projects/project-image-1.png'
import eventImage2 from '@assets/images/projects/project-image-2.png'
import eventImage3 from '@assets/images/projects/project-image-3.png'

/**
 * FeaturedEvents Component
 *
 * @description A component that displays featured and upcoming events from Astro Content Collections
 */
interface Props {
  /**
   * Additional classes to apply to the section
   */
  class?: string
  /**
   * The number of events to display
   * @default 3
   */
  limit?: number
  /**
   * The title for the section
   * @default "Upcoming events"
   */
  title?: string
  /**
   * Whether to show only featured events
   * @default false
   */
  featuredOnly?: boolean
}

const { class: className, limit = 3, title = 'Upcoming events', featuredOnly = false } = Astro.props

// Get events from content collection
const allEvents = await getCollection('events')
const now = new Date()

// Filter for upcoming events and optionally featured only
let upcomingEvents = allEvents
  .filter((event) => new Date(event.data.eventDate) >= now)
  .sort((a, b) => new Date(a.data.eventDate).getTime() - new Date(b.data.eventDate).getTime())

if (featuredOnly) {
  upcomingEvents = upcomingEvents.filter((event) => event.data.isFeatured)
}

const defaultImages = [eventImage1, eventImage2, eventImage3]

// Limit events and add default images if none provided
const featuredEvents = upcomingEvents.slice(0, limit).map((event, index) => ({
  ...event,
  displayImage: defaultImages[index % defaultImages.length],
}))

// Format date helper
const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-AU', {
    weekday: 'short',
    day: 'numeric',
    month: 'short',
    year: 'numeric',
  })
}
---

<section id="events" class:list={[className, 'my-64']}>
  <div class="container">
    <Heading level="h2" class="mb-6">{title}</Heading>
    {
      featuredEvents.length > 0 ? (
        <div class="grid grid-cols-1 gap-12 md:grid-cols-2 lg:grid-cols-3">
          {featuredEvents.map((event) => (
            <Card
              imageComponent={event.displayImage}
              url={'/events/' + event.data.slug}
              headingLevel="h2"
              title={event.data.title}
              footer={formatDate(event.data.eventDate) + ' Â· ' + event.data.location}
            >
              {event.data.description}
            </Card>
          ))}
        </div>
      ) : (
        <p class="text-lg text-gray-600 dark:text-gray-400">
          No upcoming events scheduled. Check back soon or join our Discord for announcements!
        </p>
      )
    }
    <div class="mt-12 flex flex-wrap gap-4">
      <Link href="/events/" isButton animateOnHover animationType="nudge">
        View all events
        <Icon aria-hidden="true" name="lucide:calendar" size="1.5rem" />
      </Link>
      <Link href="https://discord.gg/duca" isButton type="secondary" animateOnHover animationType="nudge" isExternal>
        Join Discord for updates
        <Icon aria-hidden="true" name="lucide:message-circle" size="1.5rem" />
      </Link>
    </div>
  </div>
</section>
