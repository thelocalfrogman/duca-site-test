---
import { Heading } from 'accessible-astro-components'
import { Icon } from 'astro-icon/components'

/**
 * StackingBoxes Component
 *
 * @description A dynamic stacking boxes animation component that reveals content as user scrolls.
 * Each box stacks on top of the previous one with a parallax-like effect.
 */
interface BoxItem {
  icon: string
  title: string
  description: string
  color: string
}

interface Props {
  /**
   * The title for the section
   */
  title?: string
  /**
   * Array of box items to display
   */
  items?: BoxItem[]
}

const defaultItems: BoxItem[] = [
  {
    icon: 'lucide:shield',
    title: 'Cybersecurity Workshops',
    description: 'Learn practical skills through hands-on workshops covering ethical hacking, network security, digital forensics, and more.',
    color: 'primary',
  },
  {
    icon: 'lucide:users',
    title: 'Community Building',
    description: 'Connect with like-minded students passionate about cybersecurity. Share knowledge, collaborate on projects, and build your network.',
    color: 'secondary',
  },
  {
    icon: 'lucide:trophy',
    title: 'CTF Competitions',
    description: 'Participate in Capture The Flag events to test your skills, solve real-world challenges, and compete with teams across Australia.',
    color: 'accent',
  },
  {
    icon: 'lucide:briefcase',
    title: 'Industry Connections',
    description: 'Meet professionals from leading cybersecurity companies, attend guest lectures, and discover internship opportunities.',
    color: 'primary',
  },
  {
    icon: 'lucide:book-open',
    title: 'Learning Resources',
    description: 'Access curated learning materials, study guides, and resources to excel in your cybersecurity studies and career.',
    color: 'secondary',
  },
  {
    icon: 'lucide:calendar',
    title: 'Regular Events',
    description: 'Join us for weekly meetups, monthly workshops, and special events throughout the semester. There\'s always something happening!',
    color: 'accent',
  },
]

const { title = 'What We Do', items = defaultItems } = Astro.props
---

<section class="stacking-section">
  <div class="container">
    <Heading level="h2" class="section-title">{title}</Heading>

    <div class="stacking-container">
      {items.map((item, index) => (
        <div
          class={`stacking-box box-${item.color}`}
          data-index={index}
          style={`--box-index: ${index};`}
        >
          <div class="box-content">
            <div class="box-icon">
              <Icon name={item.icon} size="2.5rem" />
            </div>
            <div class="box-text">
              <h3 class="box-title">{item.title}</h3>
              <p class="box-description">{item.description}</p>
            </div>
            <div class="box-number">{String(index + 1).padStart(2, '0')}</div>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  function initStackingBoxes() {
    const boxes = document.querySelectorAll('.stacking-box')
    if (!boxes.length) return

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible')
          }
        })
      },
      {
        threshold: 0.2,
        rootMargin: '-50px 0px',
      }
    )

    boxes.forEach((box) => observer.observe(box))

    // Parallax scroll effect
    const section = document.querySelector('.stacking-section')
    if (!section) return

    const handleScroll = () => {
      const sectionRect = section.getBoundingClientRect()
      const sectionTop = sectionRect.top
      const windowHeight = window.innerHeight

      if (sectionTop < windowHeight && sectionTop > -sectionRect.height) {
        boxes.forEach((box, index) => {
          const boxEl = box as HTMLElement
          const scrollProgress = Math.max(0, Math.min(1, (windowHeight - sectionTop) / (windowHeight + sectionRect.height)))
          const offset = (index * 10) * scrollProgress
          boxEl.style.transform = `translateY(${offset}px) rotate(${(index % 2 === 0 ? 1 : -1) * scrollProgress * 2}deg)`
        })
      }
    }

    window.addEventListener('scroll', handleScroll, { passive: true })
    handleScroll()

    return () => {
      window.removeEventListener('scroll', handleScroll)
      observer.disconnect()
    }
  }

  // Initialize on page load and after view transitions
  document.addEventListener('astro:page-load', initStackingBoxes)
  if (document.readyState === 'complete') {
    initStackingBoxes()
  }
</script>

<style>
  .stacking-section {
    padding: var(--space-3xl) 0;
    overflow: hidden;
  }

  .section-title {
    text-align: center;
    margin-bottom: var(--space-2xl);
  }

  .stacking-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-l);
    max-width: 900px;
    margin: 0 auto;
    perspective: 1000px;
  }

  .stacking-box {
    position: relative;
    padding: var(--space-l);
    border-radius: var(--radius-l);
    background: var(--background-color);
    border: 2px solid var(--border-color);
    box-shadow: var(--elevation-2);
    opacity: 0;
    transform: translateY(50px) scale(0.95);
    transition:
      opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1),
      transform 0.6s cubic-bezier(0.16, 1, 0.3, 1),
      box-shadow 0.3s ease;
    transition-delay: calc(var(--box-index) * 0.1s);
  }

  .stacking-box.visible {
    opacity: 1;
    transform: translateY(0) scale(1);
  }

  .stacking-box:hover {
    box-shadow: var(--elevation-4);
    z-index: 10;
  }

  /* Color variations */
  .box-primary {
    border-left: 4px solid var(--color-primary-400);
  }

  .box-primary .box-icon {
    color: var(--color-primary-400);
  }

  .box-secondary {
    border-left: 4px solid var(--color-secondary-400);
  }

  .box-secondary .box-icon {
    color: var(--color-secondary-400);
  }

  .box-accent {
    border-left: 4px solid var(--color-success-500);
  }

  .box-accent .box-icon {
    color: var(--color-success-500);
  }

  .box-content {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: var(--space-m);
    align-items: start;
  }

  .box-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    border-radius: var(--radius-m);
    background: light-dark(var(--color-neutral-100), var(--color-neutral-800));
    flex-shrink: 0;
  }

  .box-text {
    min-width: 0;
  }

  .box-title {
    font-size: var(--font-size-2);
    font-weight: 700;
    margin-bottom: var(--space-2xs);
    color: var(--foreground-color);
  }

  .box-description {
    font-size: var(--font-size-0);
    color: light-dark(var(--color-neutral-600), var(--color-neutral-400));
    line-height: 1.6;
  }

  .box-number {
    font-size: var(--font-size-4);
    font-weight: 800;
    color: light-dark(var(--color-neutral-200), var(--color-neutral-800));
    line-height: 1;
    font-feature-settings: 'tnum';
  }

  /* Alternating alignment for visual interest */
  .stacking-box:nth-child(even) {
    margin-left: var(--space-xl);
  }

  .stacking-box:nth-child(odd) {
    margin-right: var(--space-xl);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .stacking-box:nth-child(even),
    .stacking-box:nth-child(odd) {
      margin-left: 0;
      margin-right: 0;
    }

    .box-content {
      grid-template-columns: auto 1fr;
      grid-template-rows: auto auto;
    }

    .box-icon {
      width: 48px;
      height: 48px;
    }

    .box-number {
      grid-column: 1 / -1;
      position: absolute;
      top: var(--space-s);
      right: var(--space-s);
      font-size: var(--font-size-2);
      opacity: 0.3;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .stacking-box {
      opacity: 1;
      transform: none;
      transition: box-shadow 0.3s ease;
    }
  }
</style>
