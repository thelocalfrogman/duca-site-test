---
import DefaultLayout from '@layouts/DefaultLayout.astro'
import HeroSection from '@components/sections/HeroSection'
import StatsSection from '@components/sections/StatsSection'
import WhatWeDoSection from '@components/sections/WhatWeDoSection'
import TestimonialsSection from '@components/sections/TestimonialsSection'
import PartnersSection from '@components/sections/PartnersSection'
import DiscordCTASection from '@components/sections/DiscordCTASection'
import BlogPreviewSection from '@components/sections/BlogPreviewSection'
import FeaturedEventsSection from '@components/sections/FeaturedEventsSection'
import { getCollection } from 'astro:content'

// Fetch latest blog posts
const allPosts = await getCollection('blog')
const sortedPosts = allPosts
  .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime())
  .slice(0, 5)

const blogPosts = sortedPosts.map((post) => ({
  title: post.data.title,
  description: post.data.description,
  href: `/blog/${post.data.slug || post.id}`,
  image: post.data.featuredImage,
  category: post.data.tags?.[0] || 'Blog',
}))

// Fetch upcoming events (featured ones for homepage)
const allEvents = await getCollection('events')
const now = new Date()
const upcomingEvents = allEvents
  .filter((event) => new Date(event.data.eventDate) >= now)
  .sort((a, b) => new Date(a.data.eventDate).getTime() - new Date(b.data.eventDate).getTime())
  .slice(0, 3)

const featuredEvents = upcomingEvents.map((event) => ({
  title: event.data.title,
  description: event.data.description,
  eventDate: event.data.eventDate.toISOString(),
  location: event.data.location,
  registrationUrl: event.data.registrationUrl,
  slug: event.data.slug,
  tags: event.data.tags,
  featuredImage: event.data.featuredImage,
}))

// Discord API for member count
const DISCORD_INVITE_CODE = "duca"
const DISCORD_INVITE_API = `https://discord.com/api/v9/invites/${DISCORD_INVITE_CODE}?with_counts=true`

let memberCount = 750
try {
  const response = await fetch(DISCORD_INVITE_API)
  if (response.ok) {
    const data = await response.json()
    memberCount = data.approximate_member_count || 750
  }
} catch {
  // Use default
}
---

<DefaultLayout title="Home">
  <!-- Dynamic Hero Section -->
  <HeroSection client:load />

  <!-- Statistics Section -->
  <StatsSection memberCount={memberCount} client:visible />

  <!-- Partners Logo Carousel -->
  <PartnersSection client:visible />

  <!-- Featured Events Section -->
  <FeaturedEventsSection events={featuredEvents} client:visible />

  <!-- What We Do Section -->
  <WhatWeDoSection client:visible />

  <!-- Testimonials / Why Join Us -->
  <TestimonialsSection client:visible />

  <!-- Featured Blog Posts -->
  <BlogPreviewSection posts={blogPosts} client:visible />

  <!-- Discord & Join CTA -->
  <DiscordCTASection client:visible />
</DefaultLayout>

<style is:global>
  /* Ensure smooth scrolling */
  html {
    scroll-behavior: smooth;
  }
</style>
